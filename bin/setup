#!/usr/bin/env ruby
require 'pathname'
require 'fileutils'
include FileUtils

# path to your application root.
APP_ROOT = Pathname.new File.expand_path('../../', __FILE__)
APP_NAME = ENV['C9_PROJECT'] || File.base_name(APP_ROOT)
APP_CLASS = APP_NAME.gsub('-', '_').split('_').collect!{ |w| w.capitalize }.join

def system!(*args)
  system(*args) || abort("\n== Command #{args} failed ==")
end

chdir APP_ROOT do
  # This script is a starting point to setup your application.
  # Add necessary setup steps to this file.
  
  puts '== Installing Ruby 2.3.1 =='
  system `rvm install ruby-2.3.1`
  system `rvm 2.3.1`

  puts '== Installing dependencies =='
  system! 'gem install bundler --conservative'
  system('bundle check') || system!('bundle install')
  
  puts '== Updating database yml file =='
  db_yml_path = File.join(APP_ROOT, 'config', 'database.yml')
  IO.write(db_yml_path, File.open(db_yml_path) {|f| f.read.gsub(/hyperloop_/, "#{APP_NAME}_")})
  IO.write(db_yml_path, File.open(db_yml_path) {|f| f.read.gsub(/HYPERLOOP_PRODUCTION_DB_PASSWORD/, "#{APP_NAME.upcase}_PASSWORD")})

  puts "== Updating app name to #{APP_CLASS} =="
  application_path = File.join(APP_ROOT, 'config', 'application.rb')
  IO.write(application_path, File.open(application_path) {|f| f.read.gsub(/HyperloopCloneAndGo/, "#{APP_CLASS}")})
  
  puts "\n\nTo finish initialization make sure mysql is running then do a 'bundle exec rails db:create'"
  puts "For example on cloud9 workspaces you would run 'mysql-ctl start' "
end
